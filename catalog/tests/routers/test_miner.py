from typing import List
import unittest
from unittest.mock import patch
from fastapi.testclient import TestClient
from commons.logger import logger
from main import app
from services.miner import MinerService,MinerDataManager
from services.base import BaseDataManager
from sqlalchemy.sql.expression import Executable

from services.stream import StreamService
from schemas.stream import Stream,StreamMetadata,StreamField,StreamSpec
from sqlalchemy.orm.query import Query
from sqlalchemy.sql import Select

client = TestClient(app)
stream_db=[{'id': 10, 'name': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem', 'description': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem with timestep 1 day, 0:00:00 and version 1', 'signal_name': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem', 'timestep_seconds': 0, 'timestep_days': 1, 'version': '1', 'timestamp_field': 'indexed_timestamp_', 'symbol_field': 'symbol_', 'storage_backend': 'DatabaseStorage', 'same_table_name': True, 'stream_fields': [{'id': 563, 'stream_id': 10, 'name': 'donvikiemtoan', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'id': 564, 'stream_id': 10, 'name': 'ykienkiemtoan', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'id': 542, 'stream_id': 10, 'name': 'cphdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 532, 'stream_id': 10, 'name': 'chigiamdinhchidanhgiaruirodoituongduocbaohiemchikhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 552, 'stream_id': 10, 'name': 'tonglnketoantruocthue_bs', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 519, 'stream_id': 10, 'name': 'tanggiamduphongcamketdaututoithieu', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 497, 'stream_id': 10, 'name': 'tgduphongphibaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 518, 'stream_id': 10, 'name': 'tgduphongtoanhoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 541, 'stream_id': 10, 'name': 'doanhthuhdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 513, 'stream_id': 10, 'name': 'thudoinguoithuba', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 522, 'stream_id': 10, 'name': 'tanggiamduphongnghiepvubaohiemgockhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 499, 'stream_id': 10, 'name': 'tongphinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 505, 'stream_id': 10, 'name': 'thukhachdkdbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 559, 'stream_id': 10, 'name': 'indexed_timestamp_', 'type': 'timestamp without time zone', 'is_nullable': True, 'is_primary_key': False}, {'id': 540, 'stream_id': 10, 'name': 'lntuhdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 531, 'stream_id': 10, 'name': 'chidephonghanchetonthat', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 529, 'stream_id': 10, 'name': 'chidoinguoithu3', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 502, 'stream_id': 10, 'name': 'doanhthuphibaohiemthuan', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 555, 'stream_id': 10, 'name': 'lnstthunhapdn', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 561, 'stream_id': 10, 'name': 'type', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'id': 523, 'stream_id': 10, 'name': 'tgduphongboithuongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 495, 'stream_id': 10, 'name': 'phibaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 530, 'stream_id': 10, 'name': 'chixulyhangboithuong100', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 536, 'stream_id': 10, 'name': 'chihdnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 514, 'stream_id': 10, 'name': 'thuhangdaxulyboithuong100', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 549, 'stream_id': 10, 'name': 'lnkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 560, 'stream_id': 10, 'name': 'code', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'id': 547, 'stream_id': 10, 'name': 'chiphiquanlydn', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 538, 'stream_id': 10, 'name': 'tongchitructiephdkdbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 498, 'stream_id': 10, 'name': 'phinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 537, 'stream_id': 10, 'name': 'chikhachoatdongkinhdoanhbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 526, 'stream_id': 10, 'name': 'trichduphongdaodonglon', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 544, 'stream_id': 10, 'name': 'doanhthuhdtaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 527, 'stream_id': 10, 'name': 'chikhachdkdbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 516, 'stream_id': 10, 'name': 'thuboithuongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 546, 'stream_id': 10, 'name': 'lailotucongtyliendoanhlienket', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 500, 'stream_id': 10, 'name': 'tgduphongphinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 553, 'stream_id': 10, 'name': 'chiphithuetndnhienhanh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 525, 'stream_id': 10, 'name': 'tongchiboithuongvatratienbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 512, 'stream_id': 10, 'name': 'cackhoangiamtru', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 543, 'stream_id': 10, 'name': 'lnhdtaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 524, 'stream_id': 10, 'name': 'tgduphongboithuongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 496, 'stream_id': 10, 'name': 'phinhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 517, 'stream_id': 10, 'name': 'tangduphongnghiepvubaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 521, 'stream_id': 10, 'name': 'tanggiamduphongdambaocandoi', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 493, 'stream_id': 10, 'name': 'nam', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 503, 'stream_id': 10, 'name': 'hoahongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 492, 'stream_id': 10, 'name': 'quy', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 539, 'stream_id': 10, 'name': 'lngop', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 558, 'stream_id': 10, 'name': 'laicobantrencophieu', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 548, 'stream_id': 10, 'name': 'lnthuantuhdkd', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 535, 'stream_id': 10, 'name': 'chikhachdkdnhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 508, 'stream_id': 10, 'name': 'tongchiboithuong', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 528, 'stream_id': 10, 'name': 'chihoahongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 507, 'stream_id': 10, 'name': 'chiboithuong', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 533, 'stream_id': 10, 'name': 'chiphibanhangbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 551, 'stream_id': 10, 'name': 'chiphikhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 504, 'stream_id': 10, 'name': 'thuhoahongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 545, 'stream_id': 10, 'name': 'chiphitaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 510, 'stream_id': 10, 'name': 'chiboithuongnhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 554, 'stream_id': 10, 'name': 'chiphithuetndnhoanlai', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 557, 'stream_id': 10, 'name': 'lnstcuacongtyme', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 515, 'stream_id': 10, 'name': 'cackhoangiamtrukhac_chibt', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 506, 'stream_id': 10, 'name': 'doanhthuthuan', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 562, 'stream_id': 10, 'name': 'symbol_', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'id': 534, 'stream_id': 10, 'name': 'chikhachdbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 511, 'stream_id': 10, 'name': 'chiboithuongkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 550, 'stream_id': 10, 'name': 'thunhapkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 556, 'stream_id': 10, 'name': 'loiichcuacodongthieuso', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 494, 'stream_id': 10, 'name': 'doanhthuphibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 509, 'stream_id': 10, 'name': 'chiboithuongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 520, 'stream_id': 10, 'name': 'tanggiamduphongchialai', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'id': 501, 'stream_id': 10, 'name': 'cackhoangiamtrukhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}]}, {'id': 35, 'name': 'market_.stock_ohlc_days', 'description': 'market_.stock_ohlc_days with timestep 1 day, 0:00:00 and version 1', 'signal_name': 'market_.stock_ohlc_days', 'timestep_seconds': 0, 'timestep_days': 1, 'version': '1', 'timestamp_field': 'time', 'symbol_field': 'symbol', 'storage_backend': 'RedshiftStorage', 'same_table_name': True, 'stream_fields': []}, {'id': 24, 'name': 'stock_ohlc', 'description': 'stock_ohlc with timestep 1 day, 0:00:00 and version 1', 'signal_name': 'stock_ohlc', 'timestep_seconds': 0, 'timestep_days': 1, 'version': '1', 'timestamp_field': 'time', 'symbol_field': 'symbol', 'storage_backend': 'EncapDatabaseStorage', 'same_table_name': True, 'stream_fields': []}]

miner_verify_request={'kind': 'miner', 'metadata': {'description': 'Test miner', 'name': 'miner_test', 'schedule': '1 1 * * *', 'start_date': {'day': 12, 'hour': 8, 'month': 4, 'year': 2024}, 'target_symbols': ['BVH'], 'timestep': {'days': 2, 'seconds': 3600}, 'version': 1}, 'spec': {'input_streams': [{'name': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem'}, {'name': 'stock_ohlc'}, {'name': 'market_.stock_ohlc_days'}], 'output_stream': {'name': 'stream_test'}}}
expected_miner_verified={'kind': 'miner', 'metadata': {'id': None, 'name': 'miner_test', 'description': 'Test miner', 'target_symbols': 'BVH', 'timestep': {'days': 2, 'seconds': 3600}, 'start_date': {'year': 2024, 'month': 4, 'day': 12, 'hour': 8}, 'schedule': '1 1 * * *'}, 'spec': {'input_streams': [{'kind': 'stream', 'metadata': {'name': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem', 'id': 10, 'signal_name': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem', 'same_table_name': True, 'description': 'wifeed_bctc_ket_qua_kinh_doanh_bao_hiem with timestep 1 day, 0:00:00 and version 1', 'timestep': {'days': 1, 'seconds': 0}, 'timestamp_field': 'indexed_timestamp_', 'version': '1', 'to_create': False, 'symbol_field': 'symbol_', 'storage_backend': 'DatabaseStorage'}, 'spec': {'stream_fields': [{'stream_id': 10, 'name': 'donvikiemtoan', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'ykienkiemtoan', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'cphdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chigiamdinhchidanhgiaruirodoituongduocbaohiemchikhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tonglnketoantruocthue_bs', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tanggiamduphongcamketdaututoithieu', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tgduphongphibaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tgduphongtoanhoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'doanhthuhdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thudoinguoithuba', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tanggiamduphongnghiepvubaohiemgockhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tongphinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thukhachdkdbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'indexed_timestamp_', 'type': 'timestamp without time zone', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lntuhdkdkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chidephonghanchetonthat', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chidoinguoithu3', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'doanhthuphibaohiemthuan', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lnstthunhapdn', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'type', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tgduphongboithuongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'phibaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chixulyhangboithuong100', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chihdnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thuhangdaxulyboithuong100', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lnkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'code', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphiquanlydn', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tongchitructiephdkdbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'phinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chikhachoatdongkinhdoanhbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'trichduphongdaodonglon', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'doanhthuhdtaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chikhachdkdbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thuboithuongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lailotucongtyliendoanhlienket', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tgduphongphinhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphithuetndnhienhanh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tongchiboithuongvatratienbaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'cackhoangiamtru', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lnhdtaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tgduphongboithuongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'phinhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tangduphongnghiepvubaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tanggiamduphongdambaocandoi', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'nam', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'hoahongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'quy', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lngop', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'laicobantrencophieu', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lnthuantuhdkd', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chikhachdkdnhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tongchiboithuong', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chihoahongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiboithuong', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphibanhangbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphikhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thuhoahongnhuongtaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphitaichinh', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiboithuongnhantaibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiphithuetndnhoanlai', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'lnstcuacongtyme', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'cackhoangiamtrukhac_chibt', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'doanhthuthuan', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'symbol_', 'type': 'text', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chikhachdbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiboithuongkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'thunhapkhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'loiichcuacodongthieuso', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'doanhthuphibaohiem', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'chiboithuongbaohiemgoc', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'tanggiamduphongchialai', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}, {'stream_id': 10, 'name': 'cackhoangiamtrukhac', 'type': 'numeric', 'is_nullable': True, 'is_primary_key': False}]}}, {'kind': 'stream', 'metadata': {'name': 'market_.stock_ohlc_days', 'id': 35, 'signal_name': 'market_.stock_ohlc_days', 'same_table_name': True, 'description': 'market_.stock_ohlc_days with timestep 1 day, 0:00:00 and version 1', 'timestep': {'days': 1, 'seconds': 0}, 'timestamp_field': 'time', 'version': '1', 'to_create': False, 'symbol_field': 'symbol', 'storage_backend': 'RedshiftStorage'}, 'spec': {'stream_fields': []}}, {'kind': 'stream', 'metadata': {'name': 'stock_ohlc', 'id': 24, 'signal_name': 'stock_ohlc', 'same_table_name': True, 'description': 'stock_ohlc with timestep 1 day, 0:00:00 and version 1', 'timestep': {'days': 1, 'seconds': 0}, 'timestamp_field': 'time', 'version': '1', 'to_create': False, 'symbol_field': 'symbol', 'storage_backend': 'EncapDatabaseStorage'}, 'spec': {'stream_fields': []}}], 'output_stream': {'name': 'stream_test', 'id': None}}}
EXPECTED_GET_ALL_MINER="SELECT stream_cfg.id, stream_cfg.name, stream_cfg.description, stream_cfg.signal_name, stream_cfg.timestep_seconds, stream_cfg.timestep_days, stream_cfg.version, stream_cfg.timestamp_field, stream_cfg.symbol_field, stream_cfg.storage_backend, stream_cfg.same_table_name FROM stream_cfg ORDER BY stream_cfg.id LIMIT {param_1} OFFSET {param_2}"
EXPECTED_GET_ALL_FULL="SELECT miner_cfg.id, miner_cfg.name, miner_cfg.description, miner_cfg.target_symbols, miner_cfg.timestep_days, miner_cfg.timestep_seconds, miner_cfg.schedule, miner_cfg.start_date_day, miner_cfg.start_date_month, miner_cfg.start_date_year, miner_cfg.start_date_hour FROM miner_cfg WHERE miner_cfg.id IN ({param_1}) AND miner_cfg.name IN ({param_2})"
def get_streams(stream_names)->List[Stream]:
   logger.info(f'mock stream {stream_names}')
   stream_results=[stream for stream in stream_db if stream['name'] in stream_names]
   return [Stream(metadata=StreamMetadata(**stream),
                spec=StreamSpec(stream_fields=[StreamField(**stream_field) for stream_field in stream['stream_fields']]))
                 for stream in stream_results]

class TestMiner(unittest.TestCase):
    def get_raw_query(self,query:Executable):
      if isinstance(query, Select):
        query= query.compile(compile_kwargs={"literal_binds": True})
      if isinstance(query, Query):
        query=query.statement.compile(compile_kwargs={"literal_binds": True})
      return str(query).replace('\n',"")
  
    @patch.object(StreamService, 'get_streams',side_effect=get_streams)
    def test_verify_miner(self,mock_get_streams):
      res=client.post("/miner/verify",json=miner_verify_request)
      self.assertEqual(res.json(),expected_miner_verified)

    @patch.object(BaseDataManager, 'get_all')
    def test_get_miner(self,mock_get_all):
      res=client.get("/miner?id=1,2&name=abc,def&limit=3&offset=4")
      query = mock_get_all.call_args.args[0]
      raw_query=self.get_raw_query(query)

      self.assertEqual(raw_query,EXPECTED_GET_ALL_FULL.format(param_1="1, 2",param_2="'abc', 'def'"))

    @patch.object(BaseDataManager, 'get_all')
    def test_get_all_miner(self,mock_get_all):
        res=client.get("/stream?page_size=5&page_number=2")
        mock_get_all.assert_called_once()
        query = mock_get_all.call_args.args[0]
        logger.info(f"query {query}")
        raw_query=self.get_raw_query(query)
        logger.info(f"raw {raw_query}")
        self.assertEqual(raw_query,EXPECTED_GET_ALL_MINER.format(param_1=5,param_2=(2-1)*5))